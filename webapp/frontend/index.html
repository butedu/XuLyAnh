<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smile Detection Demo</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #101935 0%, #182952 40%, #3f4c77 100%);
            --card-bg: rgba(255, 255, 255, 0.92);
            --accent: #4c6ef5;
            --accent-soft: rgba(76, 110, 245, 0.1);
            --danger: #e03131;
            --text: #1f2430;
            --muted: #6c7485;
            --radius: 16px;
            --shadow: 0 24px 60px rgba(15, 20, 40, 0.25);
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            color: var(--text);
            padding: 3rem clamp(1.5rem, 4vw, 3rem);
        }

        .app {
            width: min(1100px, 100%);
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }

        header {
            text-align: center;
            color: #f4f6ff;
        }

        header h1 {
            margin: 0;
            font-size: clamp(2rem, 3vw, 2.8rem);
            font-weight: 700;
        }

        header p {
            margin-top: 0.75rem;
            font-size: 1.05rem;
            color: rgba(244, 246, 255, 0.75);
        }

        .layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.75rem;
        }

        .panel {
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            border-radius: var(--radius);
            padding: clamp(1.75rem, 3vw, 2.25rem);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel h2 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .upload-area {
            border: 2px dashed rgba(76, 110, 245, 0.4);
            border-radius: calc(var(--radius) - 6px);
            padding: clamp(2rem, 3vw, 2.5rem);
            text-align: center;
            cursor: pointer;
            transition: 0.25s ease;
            background: rgba(76, 110, 245, 0.05);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--accent);
            background: var(--accent-soft);
            transform: translateY(-2px);
        }

        .upload-area p {
            margin: 0.75rem 0 0;
            color: var(--muted);
        }

        .upload-area strong {
            color: var(--accent);
        }

        .preview-wrapper {
            position: relative;
            border-radius: calc(var(--radius) - 8px);
            overflow: hidden;
            background: #111825;
            min-height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-wrapper img {
            width: 100%;
            display: none;
            object-fit: cover;
        }

        .empty-preview {
            color: rgba(255, 255, 255, 0.35);
            font-size: 0.95rem;
        }

        .actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        button {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 0.85rem 1.6rem;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 12px 24px rgba(76, 110, 245, 0.25);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 18px 36px rgba(76, 110, 245, 0.3);
        }

        button:disabled {
            background: rgba(76, 110, 245, 0.55);
            cursor: not-allowed;
            box-shadow: none;
        }

        button.is-loading {
            position: relative;
            color: transparent;
        }

        button.is-loading::after {
            content: "Đang phân tích...";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .status {
            font-size: 0.95rem;
            color: var(--muted);
        }

        .error {
            color: var(--danger);
            font-weight: 600;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .stat {
            background: rgba(76, 110, 245, 0.12);
            border-radius: calc(var(--radius) - 10px);
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .stat span {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.75rem;
            color: rgba(31, 36, 48, 0.6);
        }

        .stat strong {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .det-list {
            display: grid;
            gap: 0.85rem;
        }

        .det-card {
            border: 1px solid rgba(67, 76, 117, 0.16);
            border-radius: calc(var(--radius) - 12px);
            padding: 0.9rem 1.1rem;
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
            background: rgba(255, 255, 255, 0.85);
        }

        .det-card header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--text);
        }

        .det-card small {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.2rem 0.65rem;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 600;
        }

        .badge-smile {
            background: rgba(24, 160, 88, 0.16);
            color: #118c4f;
        }

        .badge-nosmile {
            background: rgba(224, 49, 49, 0.14);
            color: #c02929;
        }

        .annotated-wrapper {
            border-radius: calc(var(--radius) - 12px);
            overflow: hidden;
            border: 1px solid rgba(22, 29, 49, 0.12);
            background: rgba(15, 20, 36, 0.92);
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .annotated-wrapper img {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            display: none;
        }

        .annotated-placeholder {
            padding: 1.2rem;
            text-align: center;
            color: rgba(244, 246, 255, 0.55);
            font-size: 0.92rem;
        }

        .empty-result {
            padding: 1.2rem;
            text-align: center;
            color: var(--muted);
            border: 1px dashed rgba(76, 110, 245, 0.25);
            border-radius: calc(var(--radius) - 12px);
        }

        @media (max-width: 768px) {
            body { padding: 2rem 1.25rem; }
            .panel { padding: 1.5rem; }
        }

        footer {
            text-align: center;
            font-size: 0.85rem;
            color: rgba(244, 246, 255, 0.55);
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>Smile Detection Demo</h1>
            <p>Tải ảnh nhóm, phát hiện khuôn mặt và xem ai đang mỉm cười.</p>
        </header>

        <div class="layout">
            <section class="panel">
                <h2>1. Tải ảnh</h2>
                <p class="status">
                    Hỗ trợ ảnh JPEG/PNG. Vui lòng chọn ảnh có khuôn mặt rõ và đủ sáng để kết quả tốt hơn.
                </p>
                <div id="upload" class="upload-area">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" color="var(--accent)">
                        <path d="M4 17v-1a3 3 0 0 1 3-3h1" />
                        <path d="M12 13v-9" />
                        <path d="m9 7 3-3 3 3" />
                        <path d="M9 17h6" />
                        <path d="M20 17v-1a3 3 0 0 0-3-3h-1" />
                        <path d="M3 17a4 4 0 0 0 4 4h10a4 4 0 0 0 4-4" />
                    </svg>
                    <p><strong>Kéo thả</strong> hoặc bấm để chọn ảnh</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" hidden />

                <div class="preview-wrapper">
                    <img id="preview" alt="Ảnh tải lên" />
                    <span id="previewPlaceholder" class="empty-preview">Ảnh sẽ hiển thị tại đây sau khi tải lên</span>
                </div>

                <div class="actions">
                    <button id="analyzeBtn" disabled>Phân tích ảnh</button>
                    <div id="status" class="status"></div>
                </div>
                <div id="error" class="error"></div>
            </section>

            <section class="panel">
                <h2>2. Kết quả phân tích</h2>
                <div class="stats">
                    <div class="stat">
                        <span>Tổng khuôn mặt</span>
                        <strong id="statTotal">—</strong>
                    </div>
                    <div class="stat">
                        <span>Số người cười</span>
                        <strong id="statSmile">—</strong>
                    </div>
                    <div class="stat">
                        <span>Xác suất trung bình</span>
                        <strong id="statProb">—</strong>
                    </div>
                </div>

                <div id="result" class="empty-result">Chưa có dữ liệu. Hãy chọn một bức ảnh để bắt đầu.</div>

                <div class="det-list" id="detectionList" hidden></div>

                <div class="annotated-wrapper">
                    <img id="annotated" alt="Kết quả chú thích" />
                    <div id="annotatedPlaceholder" class="annotated-placeholder">
                        Ảnh chú thích sẽ xuất hiện sau khi phân tích thành công.
                    </div>
                </div>
            </section>
        </div>

        <footer>
            Sử dụng YOLOv8-face để phát hiện khuôn mặt và CNN để phân loại nụ cười.
        </footer>
    </div>

    <script>
        const uploadArea = document.getElementById('upload');
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('preview');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');
        const detectionList = document.getElementById('detectionList');
        const annotatedImg = document.getElementById('annotated');
        const annotatedPlaceholder = document.getElementById('annotatedPlaceholder');
        const errorEl = document.getElementById('error');
        const statTotal = document.getElementById('statTotal');
        const statSmile = document.getElementById('statSmile');
        const statProb = document.getElementById('statProb');

        let selectedFile = null;

        const setLoading = loading => {
            analyzeBtn.disabled = loading || !selectedFile;
            analyzeBtn.classList.toggle('is-loading', loading);
        };

        const resetResults = () => {
            statTotal.textContent = '—';
            statSmile.textContent = '—';
            statProb.textContent = '—';
            resultEl.className = 'empty-result';
            resultEl.textContent = 'Chưa có dữ liệu. Hãy chọn một bức ảnh để bắt đầu.';
            detectionList.innerHTML = '';
            detectionList.hidden = true;
            annotatedImg.style.display = 'none';
            annotatedImg.src = '';
            annotatedPlaceholder.style.display = 'block';
        };

        const updatePreview = file => {
            const reader = new FileReader();
            reader.onload = e => {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                previewPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        };

        const handleFiles = files => {
            if (!files || !files.length) return;
            const file = files[0];
            if (!file.type.startsWith('image/')) {
                errorEl.textContent = 'Vui lòng chọn một tệp ảnh hợp lệ.';
                return;
            }
            selectedFile = file;
            updatePreview(file);
            analyzeBtn.disabled = false;
            statusEl.textContent = `File: ${file.name} • ${(file.size / 1024).toFixed(1)} KB`;
            errorEl.textContent = '';
            resetResults();
        };

        const renderDetections = detections => {
            if (!detections.length) {
                detectionList.innerHTML = '';
                detectionList.hidden = true;
                return;
            }
            detectionList.hidden = false;
            detectionList.innerHTML = detections
                .map((item, index) => {
                    const smile = item.is_smiling;
                    const prob = (item.smile_probability * 100).toFixed(1);
                    const conf = (item.confidence * 100).toFixed(1);
                    return `
                        <article class="det-card">
                            <header>
                                <span>Khuôn mặt #${index + 1}</span>
                                <span class="badge ${smile ? 'badge-smile' : 'badge-nosmile'}">
                                    ${smile ? 'Đang cười' : 'Không cười'}
                                </span>
                            </header>
                            <small>Xác suất cười: ${prob}% • Độ tự tin phát hiện: ${conf}%</small>
                            <small>Vị trí: [x=${item.box[0]}, y=${item.box[1]}, w=${item.box[2]}, h=${item.box[3]}]</small>
                        </article>
                    `;
                })
                .join('');
        };

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        analyzeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            setLoading(true);
            statusEl.textContent = 'Đang phân tích...';
            errorEl.textContent = '';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/api/detect', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Không rõ lỗi' }));
                    throw new Error(errorData.detail || 'Không thể phân tích ảnh');
                }

                const data = await response.json();
                const summary = data.summary;

                statTotal.textContent = summary.total_faces;
                statSmile.textContent = summary.smiling_faces;

                const avgProb = summary.detections?.length
                    ? summary.detections.reduce((sum, det) => sum + det.smile_probability, 0) / summary.detections.length
                    : 0;
                statProb.textContent = summary.detections?.length ? `${(avgProb * 100).toFixed(1)}%` : '—';

                resultEl.className = '';
                resultEl.innerHTML = `
                    <p>
                        Đã phát hiện <strong>${summary.total_faces}</strong> khuôn mặt, trong đó có
                        <strong>${summary.smiling_faces}</strong> người đang mỉm cười.
                    </p>
                `;

                renderDetections(summary.detections || []);

                if (data.annotated_image) {
                    annotatedImg.src = data.annotated_image;
                    annotatedImg.style.display = 'block';
                    annotatedPlaceholder.style.display = 'none';
                } else {
                    annotatedImg.style.display = 'none';
                    annotatedPlaceholder.style.display = 'block';
                }

                statusEl.textContent = summary.total_faces
                    ? 'Hoàn tất! Bạn có thể tải ảnh khác để thử thêm.'
                    : 'Không tìm thấy khuôn mặt nào. Hãy thử ảnh khác với góc chụp rõ hơn.';
            } catch (err) {
                console.error(err);
                errorEl.textContent = err.message || 'Đã xảy ra lỗi.';
                statusEl.textContent = '';
                resetResults();
            } finally {
                setLoading(false);
            }
        });

        // Khởi tạo trang ở trạng thái sạch
        resetResults();
    </script>
</body>
</html>
