<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smile Detection Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 2rem; background: #f6f7fb; color: #1a1a1a; }
        h1 { margin-bottom: 1rem; }
        .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 10px 35px rgba(0,0,0,0.08); max-width: 800px; margin: 0 auto; }
        .upload-area { border: 2px dashed #4c6ef5; border-radius: 10px; padding: 2rem; text-align: center; cursor: pointer; transition: background 0.2s ease; }
        .upload-area.dragover { background: rgba(76,110,245,0.1); }
        #preview { max-width: 100%; margin-top: 1rem; display: none; border-radius: 8px; }
        #result { margin-top: 1.5rem; }
        #result ul { padding-left: 1.2rem; }
        button { background: #4c6ef5; color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        button:disabled { background: #9aa6ff; cursor: not-allowed; }
        .annotated { margin-top: 1rem; max-width: 100%; border-radius: 8px; }
        .meta { font-size: 0.9rem; color: #555; margin-top: 1rem; }
        .error { color: #d7263d; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Smile Detection Demo</h1>
        <p>Tải ảnh nhóm lên để phát hiện khuôn mặt và đếm số người đang cười.</p>
        <div id="upload" class="upload-area">
            <p>Kéo thả ảnh vào đây hoặc bấm để chọn file</p>
            <input type="file" id="fileInput" accept="image/*" style="display:none" />
        </div>
        <img id="preview" alt="Ảnh tải lên" />
        <div style="margin-top: 1rem;">
            <button id="analyzeBtn" disabled>Phân tích ảnh</button>
        </div>
        <div id="status" class="meta"></div>
        <div id="result"></div>
        <img id="annotated" class="annotated" alt="Kết quả phân tích" />
        <div id="error" class="error"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('upload');
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('preview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');
        const annotatedImg = document.getElementById('annotated');
        const errorEl = document.getElementById('error');
        let selectedFile = null;

        const resetDisplay = () => {
            resultEl.innerHTML = '';
            annotatedImg.style.display = 'none';
            annotatedImg.src = '';
            errorEl.textContent = '';
        };

        const handleFiles = files => {
            if (!files || !files.length) return;
            const file = files[0];
            if (!file.type.startsWith('image/')) {
                errorEl.textContent = 'Vui lòng chọn một tệp ảnh.';
                return;
            }
            selectedFile = file;
            analyzeBtn.disabled = false;
            const reader = new FileReader();
            reader.onload = e => {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
            };
            reader.readAsDataURL(file);
            resetDisplay();
            statusEl.textContent = `File: ${file.name} (${Math.round(file.size / 1024)} KB)`;
        };

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        analyzeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            analyzeBtn.disabled = true;
            statusEl.textContent = 'Đang phân tích...';
            errorEl.textContent = '';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/api/detect', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Không rõ lỗi' }));
                    throw new Error(errorData.detail || 'Không thể phân tích ảnh');
                }
                const data = await response.json();
                const summary = data.summary;
                resultEl.innerHTML = `
                    <h2>Kết quả</h2>
                    <ul>
                        <li>Tổng số khuôn mặt: <strong>${summary.total_faces}</strong></li>
                        <li>Số người đang cười: <strong>${summary.smiling_faces}</strong></li>
                    </ul>
                `;
                if (data.annotated_image) {
                    annotatedImg.src = data.annotated_image;
                    annotatedImg.style.display = 'block';
                }
                if (summary.total_faces === 0) {
                    statusEl.textContent = 'Không tìm thấy khuôn mặt nào. Bạn có thể thử mô hình DNN với ảnh khó.';
                } else {
                    statusEl.textContent = 'Hoàn tất!';
                }
            } catch (err) {
                console.error(err);
                errorEl.textContent = err.message || 'Đã xảy ra lỗi.';
                statusEl.textContent = '';
            } finally {
                analyzeBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
