<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smile Detection Demo</title>
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at top left, #1f2a62 0%, #111428 55%, #090b16 100%);
            --panel-bg: rgba(17, 24, 39, 0.72);
            --panel-border: rgba(148, 163, 184, 0.14);
            --panel-shadow: 0 30px 60px rgba(6, 12, 34, 0.55);
            --primary: #6366f1;
            --primary-soft: rgba(99, 102, 241, 0.12);
            --accent: #22d3ee;
            --accent-soft: rgba(34, 211, 238, 0.12);
            --danger: #f87171;
            --text-primary: #f8fafc;
            --text-muted: #9aa2be;
            --surface-strong: rgba(248, 250, 252, 0.06);
            --radius-lg: 22px;
            --radius-md: 18px;
            --radius-sm: 12px;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: var(--bg-gradient);
            color: var(--text-primary);
            padding: clamp(2.5rem, 6vw, 4rem);
        }

        .app {
            width: min(1280px, 100%);
            display: flex;
            flex-direction: column;
            gap: clamp(2rem, 4vw, 3rem);
        }

        .hero {
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-lg);
            padding: clamp(2rem, 4vw, 3rem);
            background: linear-gradient(135deg, rgba(67, 56, 202, 0.9), rgba(14, 165, 233, 0.75));
            box-shadow: var(--panel-shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: clamp(1.8rem, 4vw, 2.6rem);
        }

        .hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.2), transparent 55%),
                        radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.25), transparent 50%);
            mix-blend-mode: screen;
            pointer-events: none;
        }

        .hero-content,
        .hero-cta {
            position: relative;
            z-index: 1;
        }

        .hero-content h1 {
            margin: 0;
            font-size: clamp(2.3rem, 4vw, 3.4rem);
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        .hero-content p {
            margin-top: 1rem;
            font-size: 1.05rem;
            max-width: 540px;
            color: rgba(255, 255, 255, 0.82);
        }

        .hero-tags {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.7rem;
        }

        .tag {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.25);
            color: var(--text-primary);
            font-size: 0.82rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .hero-cta {
            align-self: center;
            background: rgba(15, 23, 42, 0.32);
            border-radius: var(--radius-md);
            padding: clamp(1.5rem, 3vw, 2rem);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(248, 250, 252, 0.16);
            display: grid;
            gap: 1.25rem;
        }

        .hero-cta h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .hero-metric {
            display: flex;
            align-items: center;
            gap: 0.9rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            background: rgba(248, 250, 252, 0.08);
        }

        .hero-metric strong {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .hero-metric span {
            font-size: 0.92rem;
            color: rgba(241, 245, 249, 0.75);
        }

        .section-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .section-tab {
            background: var(--surface-strong);
            color: var(--text-muted);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 999px;
            padding: 0.65rem 1.4rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease, transform 0.2s ease;
        }

        .section-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 28px rgba(15, 23, 42, 0.35);
        }

        .section-tab.is-active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9), rgba(34, 211, 238, 0.85));
            color: var(--text-primary);
            border-color: rgba(148, 163, 184, 0.35);
            box-shadow: 0 18px 36px rgba(34, 211, 238, 0.25);
        }

        .section {
            display: none;
        }

        .section.is-active {
            display: block;
        }

        .section[data-section="image"] .content-grid {
            margin-top: clamp(1.5rem, 3vw, 2.5rem);
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: clamp(1.8rem, 4vw, 2.5rem);
        }

        .panel {
            position: relative;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: var(--radius-md);
            padding: clamp(1.6rem, 3vw, 2.1rem);
            box-shadow: var(--panel-shadow);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), transparent);
            opacity: 0.65;
            pointer-events: none;
        }

        .panel > * {
            position: relative;
            z-index: 1;
        }

        .panel h2 {
            margin: 0;
            font-size: 1.45rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            letter-spacing: -0.01em;
        }

        .panel h2::before {
            content: "";
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: var(--primary);
            box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.15);
        }

        .status {
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .upload-area {
            border: 1.5px dashed rgba(148, 163, 184, 0.35);
            border-radius: calc(var(--radius-md) - 6px);
            padding: clamp(2rem, 3vw, 2.4rem);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            background: rgba(15, 23, 42, 0.45);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--accent);
            box-shadow: 0 20px 35px rgba(14, 165, 233, 0.18);
            transform: translateY(-3px);
        }

        .upload-area p {
            margin: 0.9rem 0 0;
            color: rgba(226, 232, 240, 0.78);
        }

        .upload-area strong {
            color: var(--accent);
        }

        .preview-grid {
            display: grid;
            gap: clamp(1rem, 3vw, 1.5rem);
        }

        .preview-wrapper {
            position: relative;
            border-radius: calc(var(--radius-md) - 6px);
            overflow: hidden;
            background: rgba(15, 23, 42, 0.75);
            min-height: 260px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(148, 163, 184, 0.12);
        }

        .preview-wrapper img,
        .preview-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .preview-wrapper video {
            background: #000;
        }

        .empty-preview {
            color: rgba(148, 163, 184, 0.65);
            font-size: 0.95rem;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }

        button {
            background: var(--primary);
            color: var(--text-primary);
            border: none;
            padding: 0.85rem 1.7rem;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            box-shadow: 0 16px 35px rgba(99, 102, 241, 0.3);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 25px 40px rgba(99, 102, 241, 0.35);
        }

        button:disabled {
            background: rgba(99, 102, 241, 0.45);
            cursor: not-allowed;
            box-shadow: none;
        }

        button.is-loading {
            position: relative;
            color: transparent;
        }

        button.is-loading::after {
            content: "Đang xử lý...";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.16);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .error {
            color: var(--danger);
            font-weight: 600;
        }

        .results-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.1rem;
        }

        .stat-card {
            border-radius: calc(var(--radius-md) - 10px);
            padding: 1.3rem 1.4rem;
            background: rgba(99, 102, 241, 0.12);
            border: 1px solid rgba(99, 102, 241, 0.25);
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .stat-card span {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.72rem;
            color: rgba(226, 232, 240, 0.72);
        }

        .stat-card strong {
            font-size: 2.05rem;
            font-weight: 700;
        }

        .det-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
        }

        .det-card {
            border-radius: calc(var(--radius-md) - 12px);
            padding: 1rem 1.25rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            display: grid;
            gap: 0.55rem;
        }

        .det-card header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-weight: 600;
        }

        .det-card small {
            color: rgba(203, 213, 225, 0.78);
            font-size: 0.86rem;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-smile {
            background: rgba(74, 222, 128, 0.2);
            color: #bbf7d0;
        }

        .badge-nosmile {
            background: rgba(248, 113, 113, 0.2);
            color: #fecaca;
        }

        .annotated-wrapper {
            border-radius: calc(var(--radius-md) - 10px);
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.24);
            background: rgba(9, 12, 26, 0.92);
            min-height: 360px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .annotated-wrapper img,
        .annotated-wrapper video {
            width: 100%;
            max-height: 620px;
            object-fit: contain;
            display: none;
        }

        .annotated-wrapper video {
            background: #000;
        }

        .annotated-placeholder {
            padding: 1.6rem;
            text-align: center;
            color: rgba(148, 163, 184, 0.78);
            font-size: 0.96rem;
        }

        .empty-result {
            padding: 1.3rem;
            text-align: center;
            color: rgba(148, 163, 184, 0.85);
            border: 1px dashed rgba(148, 163, 184, 0.28);
            border-radius: calc(var(--radius-md) - 12px);
            background: rgba(15, 23, 42, 0.45);
        }

        .video-panel .upload-area {
            background: rgba(34, 211, 238, 0.08);
            border-color: rgba(34, 211, 238, 0.32);
        }

        .video-panel .upload-area:hover {
            box-shadow: 0 20px 45px rgba(34, 211, 238, 0.2);
        }

        .live-panel {
            margin-top: clamp(2rem, 4vw, 3rem);
            background: rgba(34, 211, 238, 0.08);
            border-color: rgba(34, 211, 238, 0.28);
        }

        .live-panel::before {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.18), transparent);
        }

        .live-view {
            position: relative;
            border-radius: calc(var(--radius-md) - 6px);
            overflow: hidden;
            border: 1px solid rgba(34, 211, 238, 0.28);
            background: rgba(8, 11, 24, 0.8);
            min-height: 320px;
        }

        .live-view video,
        .live-view canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .live-view video {
            object-fit: cover;
            filter: saturate(1.1);
        }

        .live-view canvas {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .live-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }

        .live-controls button {
            background: var(--accent);
            box-shadow: 0 16px 35px rgba(34, 211, 238, 0.28);
        }

        .live-controls button:disabled {
            background: rgba(34, 211, 238, 0.38);
            box-shadow: none;
        }

        .live-meta {
            margin-top: 1rem;
        }

        .live-summary {
            margin-top: 1rem;
            padding: 1rem 1.25rem;
            border-radius: calc(var(--radius-md) - 12px);
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(34, 211, 238, 0.22);
            color: rgba(226, 232, 240, 0.88);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .live-summary strong {
            color: var(--accent);
            font-weight: 700;
        }

        .live-status-ready {
            color: #4ade80;
        }

        .live-status-idle {
            color: rgba(148, 163, 184, 0.8);
        }

        @media (max-width: 768px) {
            body { padding: 2rem 1.25rem; }
            .hero { grid-template-columns: 1fr; }
            .hero-cta { order: -1; }
        }

        footer {
            text-align: center;
            font-size: 0.85rem;
            color: rgba(148, 163, 184, 0.7);
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="hero">
            <div class="hero-content">
                <h1>Smile Insight Studio</h1>
                <p>
                    Giải pháp thị giác máy tính giúp phát hiện nụ cười trên ảnh và video bằng YOLOv8-face
                    kết hợp mạng CNN chuyên dụng. Theo dõi thống kê trực quan ngay trên trình duyệt của bạn.
                </p>
                <div class="hero-tags">
                    <span class="tag">Realtime Vision</span>
                    <span class="tag">YOLOv8-face</span>
                    <span class="tag">SmileNet</span>
                    <span class="tag">FastAPI</span>
                </div>
            </div>
            <div class="hero-cta">
                <h3>Sẵn sàng trải nghiệm?</h3>
                <div class="hero-metric">
                    <strong>Ảnh</strong>
                    <span>Tải ảnh nhóm và nhận kết quả chú thích chi tiết trong vài giây.</span>
                </div>
                <div class="hero-metric">
                    <strong>Video</strong>
                    <span>Tạo video gắn nhãn cùng thống kê nụ cười theo thời gian thực.</span>
                </div>
            </div>
        </header>

        <nav class="section-nav">
            <button type="button" class="section-tab is-active" data-section-target="image">Ảnh</button>
            <button type="button" class="section-tab" data-section-target="video">Video</button>
            <button type="button" class="section-tab" data-section-target="camera">Camera</button>
        </nav>

        <div class="section is-active" data-section="image">
            <div class="content-grid">
                <section class="panel capture-panel">
                    <h2>1. Phân tích ảnh</h2>
                    <p class="status">
                        Kéo thả hoặc chọn ảnh JPEG/PNG. Smile Insight Studio sẽ phát hiện khuôn mặt và đánh giá nụ cười chỉ sau vài giây.
                    </p>
                    <div id="upload" class="upload-area">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" color="var(--accent)">
                            <path d="M4 17v-1a3 3 0 0 1 3-3h1" />
                            <path d="M12 13v-9" />
                            <path d="m9 7 3-3 3 3" />
                            <path d="M9 17h6" />
                            <path d="M20 17v-1a3 3 0 0 0-3-3h-1" />
                            <path d="M3 17a4 4 0 0 0 4 4h10a4 4 0 0 0 4-4" />
                        </svg>
                        <p><strong>Kéo thả</strong> hoặc bấm để chọn ảnh</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" hidden />

                    <div class="preview-grid">
                        <div class="preview-wrapper">
                            <img id="preview" alt="Ảnh tải lên" />
                            <span id="previewPlaceholder" class="empty-preview">Ảnh sẽ hiển thị tại đây sau khi tải lên.</span>
                        </div>
                        <div class="actions">
                            <button id="analyzeBtn" disabled>Phân tích ảnh</button>
                            <div id="status" class="status"></div>
                        </div>
                        <div id="error" class="error"></div>
                    </div>
                </section>

                <section class="panel results-panel">
                    <h2>2. Kết quả ảnh</h2>
                    <div class="results-meta">
                        <div class="stat-card">
                            <span>Tổng khuôn mặt</span>
                            <strong id="statTotal">—</strong>
                        </div>
                        <div class="stat-card">
                            <span>Số người cười</span>
                            <strong id="statSmile">—</strong>
                        </div>
                        <div class="stat-card">
                            <span>Xác suất trung bình</span>
                            <strong id="statProb">—</strong>
                        </div>
                    </div>

                    <div id="result" class="empty-result">Chưa có dữ liệu. Hãy chọn ảnh để bắt đầu phân tích.</div>

                    <div class="det-grid" id="detectionList" hidden></div>

                    <div class="annotated-wrapper">
                        <img id="annotated" alt="Kết quả chú thích" />
                        <div id="annotatedPlaceholder" class="annotated-placeholder">
                            Ảnh chú thích kích thước lớn sẽ hiển thị ở đây sau khi phân tích.
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <div class="section" data-section="video">
            <section class="panel video-panel">
                <h2>3. Phân tích video</h2>
                <p class="status">
                    Tải video MP4/MOV để tạo bản xuất chú thích với thống kê nụ cười theo thời gian. Hệ thống xử lý từng khung hình và trả về video mới.
                </p>
                <div id="videoUpload" class="upload-area">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" color="var(--accent)">
                        <path d="M3 7h6l2 3h10" />
                        <rect x="3" y="16" width="6" height="5" rx="1.5" />
                        <path d="M16 13h5v7h-5z" />
                        <path d="M16 16l5-3" />
                    </svg>
                    <p><strong>Kéo thả</strong> hoặc bấm để chọn video</p>
                </div>
                <input type="file" id="videoInput" accept="video/*" hidden />

                <div class="preview-grid">
                    <div class="preview-wrapper">
                        <video id="videoPreview" controls></video>
                        <span id="videoPlaceholder" class="empty-preview">Video sẽ hiển thị tại đây sau khi tải lên.</span>
                    </div>
                    <div class="actions">
                        <button id="analyzeVideoBtn" disabled>Phân tích video</button>
                        <div id="videoStatus" class="status"></div>
                    </div>
                    <div id="videoError" class="error"></div>
                </div>

                <div class="results-meta" id="videoMeta" hidden>
                    <div class="stat-card">
                        <span>Tổng khung hình</span>
                        <strong id="videoTotalFrames">—</strong>
                    </div>
                    <div class="stat-card">
                        <span>Khung hình phân tích</span>
                        <strong id="videoProcessedFrames">—</strong>
                    </div>
                    <div class="stat-card">
                        <span>Lần mỉm cười</span>
                        <strong id="videoSmileCount">—</strong>
                    </div>
                </div>

                <div id="videoSummary" class="empty-result">
                    Chưa có dữ liệu video. Hãy chọn video để bắt đầu phân tích.
                </div>

                <div class="annotated-wrapper">
                    <video id="videoResult" controls></video>
                    <div id="videoResultPlaceholder" class="annotated-placeholder">
                        Video chú thích sẽ hiển thị ở đây sau khi xử lý.
                    </div>
                </div>
            </section>
        </div>

        <div class="section" data-section="camera">
            <section class="panel live-panel">
                <h2>4. Nhận diện trực tiếp từ camera</h2>
                <p class="status">
                    Kết nối camera máy tính và nhận kết quả nụ cười gần như theo thời gian thực. Trình duyệt sẽ chỉ gửi từng khung hình cần thiết tới máy chủ.
                </p>

                <div class="live-view">
                    <video id="liveVideo" autoplay muted playsinline></video>
                    <canvas id="liveOverlay"></canvas>
                </div>

                <div class="live-controls">
                    <button id="startLiveBtn">Bắt đầu camera</button>
                    <button id="stopLiveBtn" disabled>Dừng</button>
                    <span id="liveStatus" class="status-chip live-status-idle">Chưa kích hoạt</span>
                </div>
                <div id="liveError" class="error"></div>

                <div class="results-meta live-meta">
                    <div class="stat-card">
                        <span>Khuôn mặt</span>
                        <strong id="liveTotalFaces">—</strong>
                    </div>
                    <div class="stat-card">
                        <span>Đang cười</span>
                        <strong id="liveSmilingFaces">—</strong>
                    </div>
                    <div class="stat-card">
                        <span>Tần suất</span>
                        <strong id="liveDetectionRate">—</strong>
                    </div>
                </div>

                <div id="liveSummary" class="live-summary">
                    Ngay khi camera hoạt động, các khung hình sẽ được phân tích định kỳ để cập nhật số lượng nụ cười.
                </div>
            </section>
        </div>

        <footer>
            Được vận hành bởi YOLOv8-face, SmileNet và FastAPI. <a href="https://github.com/butedu" target="_blank" rel="noreferrer">butedu</a>.
        </footer>
    </div>

    <script>
        const uploadArea = document.getElementById('upload');
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('preview');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');
        const detectionList = document.getElementById('detectionList');
        const annotatedImg = document.getElementById('annotated');
        const annotatedPlaceholder = document.getElementById('annotatedPlaceholder');
        const errorEl = document.getElementById('error');
        const statTotal = document.getElementById('statTotal');
        const statSmile = document.getElementById('statSmile');
        const statProb = document.getElementById('statProb');

        const videoUploadArea = document.getElementById('videoUpload');
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const analyzeVideoBtn = document.getElementById('analyzeVideoBtn');
        const videoStatusEl = document.getElementById('videoStatus');
        const videoErrorEl = document.getElementById('videoError');
        const videoMeta = document.getElementById('videoMeta');
        const videoTotalFrames = document.getElementById('videoTotalFrames');
        const videoProcessedFrames = document.getElementById('videoProcessedFrames');
        const videoSmileCount = document.getElementById('videoSmileCount');
        const videoSummaryEl = document.getElementById('videoSummary');
        const videoResult = document.getElementById('videoResult');
        const videoResultPlaceholder = document.getElementById('videoResultPlaceholder');
        const liveVideo = document.getElementById('liveVideo');
        const liveOverlay = document.getElementById('liveOverlay');
        const startLiveBtn = document.getElementById('startLiveBtn');
        const stopLiveBtn = document.getElementById('stopLiveBtn');
        const liveStatusChip = document.getElementById('liveStatus');
        const liveErrorEl = document.getElementById('liveError');
        const liveTotalFaces = document.getElementById('liveTotalFaces');
        const liveSmilingFaces = document.getElementById('liveSmilingFaces');
        const liveDetectionRate = document.getElementById('liveDetectionRate');
        const liveSummary = document.getElementById('liveSummary');
        const sectionTabs = Array.from(document.querySelectorAll('.section-tab'));
        const sectionBlocks = Array.from(document.querySelectorAll('[data-section]'));

        let selectedFile = null;
        let selectedVideo = null;
        let previewVideoUrl = null;
        let resultVideoUrl = null;
        let liveStream = null;
        let liveIntervalId = null;
        let liveProcessing = false;
        let lastLiveDetection = null;
        let liveDetectionsCount = 0;
        let liveStartTimestamp = null;
        let currentSection = 'image';
        const LIVE_CAPTURE_INTERVAL = 1200;
        const liveCaptureCanvas = document.createElement('canvas');
        const liveCaptureCtx = liveCaptureCanvas.getContext('2d');

        const setLoading = loading => {
            analyzeBtn.disabled = loading || !selectedFile;
            analyzeBtn.classList.toggle('is-loading', loading);
        };

        const resetResults = () => {
            statTotal.textContent = '—';
            statSmile.textContent = '—';
            statProb.textContent = '—';
            resultEl.className = 'empty-result';
            resultEl.textContent = 'Chưa có dữ liệu. Hãy chọn một bức ảnh để bắt đầu.';
            detectionList.innerHTML = '';
            detectionList.hidden = true;
            annotatedImg.style.display = 'none';
            annotatedImg.src = '';
            annotatedPlaceholder.style.display = 'block';
        };

        const updatePreview = file => {
            const reader = new FileReader();
            reader.onload = e => {
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                previewPlaceholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        };

        const handleFiles = files => {
            if (!files || !files.length) return;
            const file = files[0];
            if (!file.type.startsWith('image/')) {
                errorEl.textContent = 'Vui lòng chọn một tệp ảnh hợp lệ.';
                return;
            }
            selectedFile = file;
            updatePreview(file);
            analyzeBtn.disabled = false;
            statusEl.textContent = `File: ${file.name} • ${(file.size / 1024).toFixed(1)} KB`;
            errorEl.textContent = '';
            resetResults();
            activateSection('image');
        };

        const renderDetections = detections => {
            if (!detections.length) {
                detectionList.innerHTML = '';
                detectionList.hidden = true;
                return;
            }
            detectionList.hidden = false;
            detectionList.innerHTML = detections
                .map((item, index) => {
                    const smile = item.is_smiling;
                    const prob = (item.smile_probability * 100).toFixed(1);
                    const conf = (item.confidence * 100).toFixed(1);
                    return `
                        <article class="det-card">
                            <header>
                                <span>Khuôn mặt #${index + 1}</span>
                                <span class="badge ${smile ? 'badge-smile' : 'badge-nosmile'}">
                                    ${smile ? 'Đang cười' : 'Không cười'}
                                </span>
                            </header>
                            <small>Xác suất cười: ${prob}% • Độ tự tin phát hiện: ${conf}%</small>
                            <small>Vị trí: [x=${item.box[0]}, y=${item.box[1]}, w=${item.box[2]}, h=${item.box[3]}]</small>
                        </article>
                    `;
                })
                .join('');
        };

        const setVideoLoading = loading => {
            analyzeVideoBtn.disabled = loading || !selectedVideo;
            analyzeVideoBtn.classList.toggle('is-loading', loading);
        };

        const resetVideoResults = () => {
            videoMeta.hidden = true;
            videoTotalFrames.textContent = '—';
            videoProcessedFrames.textContent = '—';
            videoSmileCount.textContent = '—';
            videoSummaryEl.className = 'empty-result';
            videoSummaryEl.textContent = 'Chưa có dữ liệu video. Hãy chọn video để bắt đầu phân tích.';
            if (resultVideoUrl) {
                URL.revokeObjectURL(resultVideoUrl);
                resultVideoUrl = null;
            }
            if (videoResult) {
                videoResult.pause();
                videoResult.removeAttribute('src');
                videoResult.load();
                videoResult.style.display = 'none';
            }
            videoResultPlaceholder.style.display = 'block';
        };

        const updateVideoPreview = file => {
            if (previewVideoUrl) {
                URL.revokeObjectURL(previewVideoUrl);
            }
            previewVideoUrl = URL.createObjectURL(file);
            videoPreview.src = previewVideoUrl;
            videoPreview.style.display = 'block';
            videoPlaceholder.style.display = 'none';
        };

        const handleVideoFiles = files => {
            if (!files || !files.length) return;
            const file = files[0];
            if (!file.type.startsWith('video/')) {
                videoErrorEl.textContent = 'Vui lòng chọn một tệp video hợp lệ.';
                selectedVideo = null;
                analyzeVideoBtn.disabled = true;
                videoStatusEl.textContent = '';
                if (previewVideoUrl) {
                    URL.revokeObjectURL(previewVideoUrl);
                    previewVideoUrl = null;
                }
                videoPreview.removeAttribute('src');
                videoPreview.style.display = 'none';
                videoPlaceholder.style.display = 'block';
                return;
            }
            selectedVideo = file;
            updateVideoPreview(file);
            analyzeVideoBtn.disabled = false;
            videoStatusEl.textContent = `File: ${file.name} • ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            videoErrorEl.textContent = '';
            resetVideoResults();
            activateSection('video');
        };

        const renderVideoMeta = summary => {
            const totalFrames = summary.total_frames ?? 0;
            const processedFrames = summary.processed_frames ?? 0;
            const smileCount = summary.smiles_detected ?? 0;
            videoMeta.hidden = false;
            videoTotalFrames.textContent = totalFrames;
            videoProcessedFrames.textContent = processedFrames;
            videoSmileCount.textContent = smileCount;
        };

        const setLiveStatus = (message, isActive) => {
            liveStatusChip.textContent = message;
            liveStatusChip.classList.toggle('live-status-ready', Boolean(isActive));
            liveStatusChip.classList.toggle('live-status-idle', !isActive);
        };

        const clearLiveOverlay = () => {
            const ctx = liveOverlay.getContext('2d');
            if (!ctx) return;
            ctx.clearRect(0, 0, liveOverlay.width, liveOverlay.height);
        };

        const syncLiveOverlaySize = () => {
            if (!liveVideo.videoWidth || !liveVideo.videoHeight) return;
            if (liveOverlay.width !== liveVideo.videoWidth || liveOverlay.height !== liveVideo.videoHeight) {
                liveOverlay.width = liveVideo.videoWidth;
                liveOverlay.height = liveVideo.videoHeight;
                clearLiveOverlay();
            }
        };

        const drawLiveOverlay = detections => {
            const ctx = liveOverlay.getContext('2d');
            if (!ctx) return;
            ctx.clearRect(0, 0, liveOverlay.width, liveOverlay.height);
            detections.forEach(item => {
                const box = item.box || [];
                if (box.length < 4) {
                    return;
                }
                const [x, y, w, h] = box;
                const smiling = Boolean(item.is_smiling);
                const probability = item.smile_probability ?? 0;
                ctx.lineWidth = 3;
                ctx.strokeStyle = smiling ? 'rgba(34, 211, 238, 0.9)' : 'rgba(248, 113, 113, 0.9)';
                ctx.strokeRect(x, y, w, h);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.55)';
                ctx.fillRect(x, Math.max(y - 26, 0), Math.min(w, liveOverlay.width - x), 24);
                ctx.font = '16px "Inter", sans-serif';
                ctx.fillStyle = smiling ? 'rgba(34, 211, 238, 0.95)' : 'rgba(248, 113, 113, 0.95)';
                ctx.fillText(`${Math.round(probability * 100)}%`, x + 6, Math.max(y - 8, 16));
            });
        };

        const resetLiveStats = () => {
            liveTotalFaces.textContent = '—';
            liveSmilingFaces.textContent = '—';
            liveDetectionRate.textContent = '—';
            liveSummary.innerHTML = 'Ngay khi camera hoạt động, các khung hình sẽ được phân tích định kỳ để cập nhật số lượng nụ cười.';
            lastLiveDetection = null;
            liveDetectionsCount = 0;
            liveStartTimestamp = null;
            clearLiveOverlay();
        };

        const captureLiveFrame = async () => {
            if (!liveVideo.videoWidth || !liveVideo.videoHeight) return null;
            liveCaptureCanvas.width = liveVideo.videoWidth;
            liveCaptureCanvas.height = liveVideo.videoHeight;
            liveCaptureCtx.drawImage(liveVideo, 0, 0, liveCaptureCanvas.width, liveCaptureCanvas.height);
            const blob = await new Promise(resolve => liveCaptureCanvas.toBlob(resolve, 'image/jpeg', 0.85));
            return blob;
        };

        const handleLiveResponse = summary => {
            const totalFaces = summary.total_faces ?? 0;
            const smilingFaces = summary.smiling_faces ?? 0;
            const detections = summary.detections || [];

            liveTotalFaces.textContent = totalFaces;
            liveSmilingFaces.textContent = smilingFaces;
            drawLiveOverlay(detections);

            const now = Date.now();
            if (!liveStartTimestamp) {
                liveStartTimestamp = now;
                liveDetectionsCount = 0;
            }
            liveDetectionsCount += 1;
            lastLiveDetection = now;
            const elapsed = (now - liveStartTimestamp) / 1000;
            const rate = elapsed > 0 ? liveDetectionsCount / elapsed : 0;
            liveDetectionRate.textContent = `${rate.toFixed(2)} Hz`;

            if (totalFaces) {
                liveSummary.innerHTML = `Đang thấy <strong>${totalFaces}</strong> khuôn mặt, trong đó <strong>${smilingFaces}</strong> người mỉm cười.`;
            } else {
                liveSummary.innerHTML = 'Không phát hiện khuôn mặt nào trong khung hình hiện tại.';
            }
        };

        const analyzeLiveFrame = async () => {
            if (liveProcessing) return;
            liveProcessing = true;
            try {
                const frameBlob = await captureLiveFrame();
                if (!frameBlob) {
                    liveProcessing = false;
                    return;
                }
                const formData = new FormData();
                formData.append('file', frameBlob, 'frame.jpg');
                const response = await fetch('/api/detect', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Không rõ lỗi' }));
                    throw new Error(errorData.detail || 'Không thể phân tích khung hình camera');
                }
                const data = await response.json();
                handleLiveResponse(data.summary || {});
                setLiveStatus('Đang nhận diện...', true);
            } catch (err) {
                console.error(err);
                liveErrorEl.textContent = err.message || 'Đã xảy ra lỗi khi xử lý camera.';
                stopLiveCapture();
                setLiveStatus('Tạm dừng do lỗi', false);
            } finally {
                liveProcessing = false;
            }
        };

        const stopLiveCapture = () => {
            if (liveIntervalId) {
                clearInterval(liveIntervalId);
                liveIntervalId = null;
            }
            if (liveStream) {
                liveStream.getTracks().forEach(track => track.stop());
                liveStream = null;
            }
            if (liveVideo) {
                liveVideo.pause();
                liveVideo.srcObject = null;
            }
            liveProcessing = false;
            resetLiveStats();
            setLiveStatus('Đã dừng', false);
            if (startLiveBtn) {
                startLiveBtn.disabled = false;
            }
            if (stopLiveBtn) {
                stopLiveBtn.disabled = true;
            }
        };

        const startLiveCapture = async () => {
            if (liveStream || liveProcessing) {
                return;
            }
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                liveErrorEl.textContent = 'Trình duyệt của bạn không hỗ trợ truy cập camera.';
                return;
            }
            if (startLiveBtn) {
                startLiveBtn.disabled = true;
            }
            if (!liveVideo || !liveOverlay) {
                liveErrorEl.textContent = 'Không tìm thấy thành phần hiển thị camera trên trang.';
                if (startLiveBtn) {
                    startLiveBtn.disabled = false;
                }
                return;
            }
            liveErrorEl.textContent = '';
            resetLiveStats();
            try {
                activateSection('camera');
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                liveStream = stream;
                liveVideo.srcObject = stream;
                await liveVideo.play();
                syncLiveOverlaySize();
                setLiveStatus('Đang khởi tạo...', true);
                if (stopLiveBtn) {
                    stopLiveBtn.disabled = false;
                }
                liveIntervalId = setInterval(analyzeLiveFrame, LIVE_CAPTURE_INTERVAL);
                await analyzeLiveFrame();
            } catch (err) {
                console.error(err);
                liveErrorEl.textContent = err.message || 'Không thể khởi tạo camera.';
                setLiveStatus('Chưa kích hoạt', false);
                if (startLiveBtn) {
                    startLiveBtn.disabled = false;
                }
            }
        };

        function activateSection(sectionKey) {
            if (!sectionKey) {
                return;
            }
            if (currentSection === 'camera' && sectionKey !== 'camera') {
                stopLiveCapture();
            }
            currentSection = sectionKey;
            sectionTabs.forEach(button => {
                const isActive = button.dataset.sectionTarget === sectionKey;
                button.classList.toggle('is-active', isActive);
            });
            sectionBlocks.forEach(block => {
                const isActive = block.dataset.section === sectionKey;
                block.classList.toggle('is-active', isActive);
            });
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        sectionTabs.forEach(button => {
            button.addEventListener('click', () => activateSection(button.dataset.sectionTarget || 'image'));
        });

        analyzeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            setLoading(true);
            statusEl.textContent = 'Đang phân tích...';
            errorEl.textContent = '';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/api/detect', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Không rõ lỗi' }));
                    throw new Error(errorData.detail || 'Không thể phân tích ảnh');
                }

                const data = await response.json();
                const summary = data.summary;

                statTotal.textContent = summary.total_faces;
                statSmile.textContent = summary.smiling_faces;

                const avgProb = summary.detections?.length
                    ? summary.detections.reduce((sum, det) => sum + det.smile_probability, 0) / summary.detections.length
                    : 0;
                statProb.textContent = summary.detections?.length ? `${(avgProb * 100).toFixed(1)}%` : '—';

                resultEl.className = '';
                resultEl.innerHTML = `
                    <p>
                        Đã phát hiện <strong>${summary.total_faces}</strong> khuôn mặt, trong đó có
                        <strong>${summary.smiling_faces}</strong> người đang mỉm cười.
                    </p>
                `;

                renderDetections(summary.detections || []);
                activateSection('image');

                if (data.annotated_image) {
                    annotatedImg.src = data.annotated_image;
                    annotatedImg.style.display = 'block';
                    annotatedPlaceholder.style.display = 'none';
                } else {
                    annotatedImg.style.display = 'none';
                    annotatedPlaceholder.style.display = 'block';
                }

                statusEl.textContent = summary.total_faces
                    ? 'Hoàn tất! Bạn có thể tải ảnh khác để thử thêm.'
                    : 'Không tìm thấy khuôn mặt nào. Hãy thử ảnh khác với góc chụp rõ hơn.';
            } catch (err) {
                console.error(err);
                errorEl.textContent = err.message || 'Đã xảy ra lỗi.';
                statusEl.textContent = '';
                resetResults();
            } finally {
                setLoading(false);
            }
        });

        if (videoUploadArea) {
            videoUploadArea.addEventListener('click', () => videoInput.click());
            videoUploadArea.addEventListener('dragover', e => {
                e.preventDefault();
                videoUploadArea.classList.add('dragover');
            });
            videoUploadArea.addEventListener('dragleave', () => videoUploadArea.classList.remove('dragover'));
            videoUploadArea.addEventListener('drop', e => {
                e.preventDefault();
                videoUploadArea.classList.remove('dragover');
                handleVideoFiles(e.dataTransfer.files);
            });
        }
        if (videoInput) {
            videoInput.addEventListener('change', () => handleVideoFiles(videoInput.files));
        }

        analyzeVideoBtn.addEventListener('click', async () => {
            if (!selectedVideo) return;
            activateSection('video');
            setVideoLoading(true);
            videoStatusEl.textContent = 'Đang xử lý video...';
            videoErrorEl.textContent = '';

            const formData = new FormData();
            formData.append('file', selectedVideo);

            try {
                const response = await fetch('/api/detect-video', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Không rõ lỗi' }));
                    throw new Error(errorData.detail || 'Không thể phân tích video');
                }

                const data = await response.json();
                const summary = data.summary || {};
                renderVideoMeta(summary);

                const facesTotal = summary.faces_detected ?? 0;
                const smilesTotal = summary.smiles_detected ?? 0;
                const durationText = summary.duration_seconds ? `${summary.duration_seconds} giây` : null;
                const avgSmiles = typeof summary.avg_smiles_per_processed_frame === 'number'
                    ? summary.avg_smiles_per_processed_frame.toFixed(2)
                    : null;
                const avgFaces = typeof summary.avg_faces_per_processed_frame === 'number'
                    ? summary.avg_faces_per_processed_frame.toFixed(2)
                    : null;

                videoSummaryEl.className = '';
                let summaryHtml = `
                    <p>
                        Đã xử lý <strong>${summary.total_frames ?? 0}</strong> khung hình,
                        phát hiện <strong>${facesTotal}</strong> khuôn mặt và ghi nhận
                        <strong>${smilesTotal}</strong> lần mỉm cười.
                    </p>
                `;
                if (durationText) {
                    summaryHtml += `<p>Thời lượng ước tính của video: ${durationText}.</p>`;
                }
                if (avgFaces) {
                    summaryHtml += `<p>Trung bình ${avgFaces} khuôn mặt trên mỗi khung hình được phân tích.</p>`;
                }
                if (avgSmiles) {
                    summaryHtml += `<p>Trung bình ${avgSmiles} lần mỉm cười trên mỗi khung hình được phân tích.</p>`;
                }
                videoSummaryEl.innerHTML = summaryHtml;

                if (data.download_url) {
                    const videoResp = await fetch(data.download_url);
                    if (!videoResp.ok) {
                        throw new Error('Không thể tải video kết quả');
                    }
                    const blob = await videoResp.blob();
                    if (resultVideoUrl) {
                        URL.revokeObjectURL(resultVideoUrl);
                    }
                    resultVideoUrl = URL.createObjectURL(blob);
                    videoResult.src = resultVideoUrl;
                    videoResult.style.display = 'block';
                    videoResultPlaceholder.style.display = 'none';
                    videoResult.load();
                } else {
                    videoResult.style.display = 'none';
                    videoResultPlaceholder.style.display = 'block';
                }

                videoStatusEl.textContent = 'Hoàn tất! Video đã được chú thích.';
            } catch (err) {
                console.error(err);
                videoErrorEl.textContent = err.message || 'Đã xảy ra lỗi khi xử lý video.';
                videoStatusEl.textContent = '';
                resetVideoResults();
            } finally {
                setVideoLoading(false);
            }
        });

        if (startLiveBtn && stopLiveBtn) {
            startLiveBtn.addEventListener('click', startLiveCapture);
            stopLiveBtn.addEventListener('click', stopLiveCapture);
        }
        if (liveVideo) {
            liveVideo.addEventListener('loadedmetadata', syncLiveOverlaySize);
            liveVideo.addEventListener('resize', syncLiveOverlaySize);
            liveVideo.addEventListener('playing', syncLiveOverlaySize);
        }
        window.addEventListener('beforeunload', stopLiveCapture);

        // Khởi tạo trang ở trạng thái sạch
        resetResults();
        resetVideoResults();
        resetLiveStats();
        activateSection('image');
    </script>
</body>
</html>
